IP协议位于OSI参考模型中的第三层 - 网络层（下面有数据链路层和物理层）

# 作用

ip协议的作用就是在复杂的网络环境下把数据报发送到目标节点

数据链路层定义了通过通信介质互连的设备间的数据传输规范，简单的说就是只关心的同一个网络内的通信，当跨多个网络通信的时候数据链路层就无能无力。这时候就需要IP协议来实现互联网中节点之间的通信。

# 基础

## 路由控制

路由控制表

## 无连接的

ip是无连接的，上层tcp协议提供连接服务



# IP协议的基础知识

### ip地址

IP 地址固定32bit， 习惯用点分十进制表示，如 172.18.1.0

IP协议头部就需要填写源IP地址、和目标IP地址， 用于把数据报投递给特定的节点 以及让节点可以根据源IP地址回信

### 网络标识和主机标识

IP地址分成两部分：网络标识 和 主机标识。

### IP地址的分类

#### A类地址

A类地址以0开头，前8位位网络标识，后24位位主机标识。所以理论上一个A类网段可以有2^24 - 2 个主机地址。

网络地址范围为0.0.0.0 ～ 127.0.0.0

![image-20200914234614679](/Users/pepper/Library/Application Support/typora-user-images/image-20200914234614679.png)

#### B类地址

B类地址以10开头， 前16位为网络标识，后16位为主机标识

网络地址范围为128.0.0.0 ～ 191.255.0.0

#### C类地址

C类地址以110开头， 前24位为网络标识，后8位为主机标识

网络地址范围为192.0.0.0 ～ 223.255.255.0

#### D类地址

C类地址以1110开头， 1到32位都是网络标识位，没有主机标识

地址范围为224.0.0.0 ～ 239.255.255.255，常被用于多播地址

### 广播地址

主机标识全0的时候代表网络地址， 全1的时候代表广播地址

分为本地广播地址和直接广播地址

本地广播地址是在本网络内的广播地址，路由器会直接屏蔽，不会到其他链路

直接广播地址是可以跨链路的

#### 多播

多播用于将数据发送到组内的所有主机

单播的时候 源主机发送多份数据到多个主机

广播发送数据到当前链路的所有主机，由ip上层协议判断是否需要接受数据，而且广播无法穿透路由

ip多播使用d类地址：1110 + 28位的多播组号

#### 子网掩码

直接使用A类、B类、C类地址可能会显得比较浪费 （架构一个B类IP网络时一个链路允许6万5千多主机）

子网掩码用于确定网络标识的长度

比如某个网络的掩码是 255.255.255.192 那就代表网络标识的长度为 26位

如一个ip 位 172.20.100.52 掩码位  255.255.255.192 那么网络地址就为 172.20.100.0 /26 

#### CIDR 和 VLSM

放弃使用IP地址的分类， 采用任意长度分割IP地址的网络标识和主机标识，叫做CIDR.

#### 全局地址和私有地址

缓解ip地址不足的问题

私有地址

A类 10.0.0.0 ～10.255.255.255 （10/8）

B类 172.16.0.0. ～ 172.31.255.255（172.16/16）

C类 192.168.0.0 ～ 192.168.255.255 （192.168/ 16）

现在普遍的做法是 LAN中的私有IP + NAT 进行互联网通信

### 路由控制

路由控制表中记录着网络地址与下一个路由器的地址

IP包经过路由器时， 首先确定目的IP地址， 再从路由控制表中寻找与该地址具有相同网络标识的记录，根据该记录将IP包转发给相应的下一个路由器（如果有多条网络地址相同的记录，选择最匹配的那条记录）

#### 环回地址

127.0.0.1/localhost 同一主机程序之间的网络通信

#### 路由控制表的聚合

记录的聚合，缩小路由表的大小

比如路由控制表中有两条记录 

172.18.1.0/25  A路由器 和 172.18.1.128/25 A路由器  

则可以聚合成  172.18.1.0/24 A路由器 一条记录， 节省了路由器的内存和cpu

### IP分割与再构成处理

### MTU

数据链路不同，则MTU不同， 以太网的MTU为1500

#### IP分片与重组

IP数据报的最大大小为65536字节， 而数据链路的MTU可能小很多（以太网为1500），所以需要对IP数据包进行分片

把一个IP报拆成多个就叫做IP分片，

路由器和源主机都可以对IP进行分片，但是只有在目标机器才会进行重组

#### 路径MTU发现

分片机制会有很多不足，比如造成路由器的负荷加重，比如多个分片中的一个分片丢失整个IP数据报作废。所以尽量不要在路由器进行分片

路径MTU：指从发送端到接收端主机之间不需要分片时最大MTU大小（路径中所有数据链路的最小MTU）

路径MTU发现原理：

udp例子：

发送数据报时设置ip首部的分片标识设为禁止分片

路由器收到数据报时，如果需要分片才能发送到下一个路由器时，直接丢器报文，同时发送一个ICMP报文通知MTU值到源节点

源节点收到这个ICMP消息时更新最大MTU值，并且下一次发送数据报进行分片处理

tcp的时候

TCP的情况下根据MTU更新MSS（最大段长度）

之所以更新tcp的最大段长度，是避免IP层进行分片（ip分片丢失，导致整个ip数据报废弃， 都需要重传）

#### IP v4首部

一般为5 * 4 字节

第一个4字节 主要表示ip协议版本 + ip首部长度 + TOS + ip数据报长度

第二个4字节 主要用于ip分片相关 （标识 + 是否允许分片 + 是否最后一个分片 + 分片偏移量）

第三个4字节 TTL + 上层协议类型 + 首部校验和

第四个4字节 源IP地址

第五个4字节 目标IP地址





































